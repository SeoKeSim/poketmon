<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì¦ê²¨ì°¾ê¸° - í¬ì¼“ëª¬ ë„ê°</title>
    <link rel="stylesheet" href="/css/favorites.css">
</head>
<body>
{{>header}}

<div class="favorites-container">
    <div class="favorites-header">
        <h1 class="page-title">â­ ë‚´ ì¦ê²¨ì°¾ê¸°</h1>
        <p class="favorites-count">ì´ <span id="favoriteCount">{{favoriteCount}}</span>ë§ˆë¦¬ì˜ í¬ì¼“ëª¬</p>
    </div>

    {{#hasFavorites}}
        <div class="favorites-grid" id="favoritesGrid">
            {{#favorites}}
                <div class="pokemon-card" data-pokemon-id="{{pokemonId}}">
                    <div class="pokemon-image-container">
                        <img src="{{pokemonImageUrl}}" alt="{{pokemonKoreanName}}" class="pokemon-image">
                        <button class="remove-favorite-btn" data-pokemon-id="{{pokemonId}}" title="ì¦ê²¨ì°¾ê¸° í•´ì œ">
                            â¤ï¸
                        </button>
                    </div>

                    <div class="pokemon-info">
                        <div class="pokemon-number">#{{pokemonId}}</div>
                        <div class="pokemon-name-ko">{{pokemonKoreanName}}</div>
                        <div class="pokemon-name-en">{{pokemonName}}</div>
                        <div class="added-date">{{#formatDate}}{{createdAt}}{{/formatDate}} ì¶”ê°€</div>
                    </div>

                    <div class="card-actions">
                        <button class="view-detail-btn" data-pokemon-name="{{pokemonName}}">
                            ìƒì„¸ë³´ê¸°
                        </button>
                    </div>
                </div>
            {{/favorites}}
        </div>
    {{/hasFavorites}}

    {{^hasFavorites}}
        <div class="empty-favorites">
            <div class="empty-icon">ğŸ’”</div>
            <h2>ì•„ì§ ì¦ê²¨ì°¾ê¸°í•œ í¬ì¼“ëª¬ì´ ì—†ì–´ìš”</h2>
            <p>í¬ì¼“ëª¬ì„ ê²€ìƒ‰í•˜ê³  ë§ˆìŒì— ë“œëŠ” í¬ì¼“ëª¬ì„ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            <a href="/" class="search-btn">í¬ì¼“ëª¬ ê²€ìƒ‰í•˜ê¸°</a>
        </div>
    {{/hasFavorites}}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì¦ê²¨ì°¾ê¸° í•´ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.remove-favorite-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const pokemonId = this.dataset.pokemonId;
                removeFavorite(pokemonId);
            });
        });

        // ìƒì„¸ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('.view-detail-btn').forEach(button => {
            button.addEventListener('click', function() {
                const pokemonName = this.dataset.pokemonName;
                searchPokemon(pokemonName);
            });
        });

        // í¬ì¼“ëª¬ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ (ìƒì„¸ë³´ê¸°ì™€ ë™ì¼)
        document.querySelectorAll('.pokemon-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë¬´ì‹œ
                if (e.target.classList.contains('remove-favorite-btn') ||
                        e.target.classList.contains('view-detail-btn')) {
                    return;
                }

                const pokemonId = this.dataset.pokemonId;
                const pokemonName = this.querySelector('.pokemon-name-en').textContent;
                searchPokemon(pokemonName);
            });
        });
    });

    // ì¦ê²¨ì°¾ê¸° í•´ì œ í•¨ìˆ˜
    async function removeFavorite(pokemonId) {
        if (!confirm('ì •ë§ë¡œ ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            const response = await fetch(`/api/favorites/${pokemonId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success) {
                // ì¹´ë“œ ì œê±° ì• ë‹ˆë©”ì´ì…˜
                const card = document.querySelector(`[data-pokemon-id="${pokemonId}"]`);
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8)';

                setTimeout(() => {
                    card.remove();
                    updateFavoriteCount();
                    checkEmptyState();
                }, 300);

                showMessage('ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showMessage(result.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í¬ì¼“ëª¬ ê²€ìƒ‰ (ìƒì„¸ë³´ê¸°)
    function searchPokemon(pokemonName) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/search';
        form.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'query';
        input.value = pokemonName;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // ì¦ê²¨ì°¾ê¸° ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateFavoriteCount() {
        const remainingCards = document.querySelectorAll('.pokemon-card').length;
        document.getElementById('favoriteCount').textContent = remainingCards;
    }

    // ë¹ˆ ìƒíƒœ ì²´í¬
    function checkEmptyState() {
        const remainingCards = document.querySelectorAll('.pokemon-card').length;
        if (remainingCards === 0) {
            location.reload();
        }
    }

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        background-color: ${type === 'success' ? '#28a745' : '#dc3545'};
    `;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => messageDiv.remove(), 300);
        }, 3000);
    }

    // ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
    document.head.appendChild(style);
</script>

</body>
</html>